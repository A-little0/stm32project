倒立摆调试日记

2023/5/25 解决编码器捕获脉冲问题
	    脉冲计数错误是因为采样频率的问题，由原先 分频系数72-1和 计数值arr 1000-1,改为分频系数720-1，计数值arr 2000-1
2023/5/27 在考虑用角度环串速度环的pid时，由于角度值为电位器ADC采样电压，之前未对采样值进行处理转换，而是使用0~4091角度变化范围，
pid系数极易使输出超过占空比的最大限度，通过  采样值*360/4096 转换为0~360度变化范围
2023/5/29 阅读大量文献后，有大量文献都提及只有角度环难以让摆杆保持直立的姿态，还要加入电机的位置环，进行串级pid控制，本文件为副本文件，
尝试加入位置环的控制
2023/5/29 在将控制周期和采样周期都将0.02s改为2ms后单个角度环就能平衡（但较多情况下会往一个方向上加速旋转，最后倒下），但系统的鲁棒性很低，
2023/5/31 如何增加位置环？
     	    1 角度环输出当位置环目标
	    2 角度环和位置环并行输出
2023/6/1 如果角度环串位置环，角度环的输出当做位置环的目标，如何理解？摆杆的内心独白：我现在距离平衡位置偏差了x度，现在我需要电机（摆臂）迅速往对应方向旋转到y位置上.这样角度环的输出当位置环的物理意义也就合乎情理。
【chatgpt】 串级PID控制器是由两个或多个PID控制器组成的控制系统，通常用于具有多个控制变量的复杂过程。串级PID控制器的调参需要考虑多个因	    素，包括系统的稳定性、响应速度、控制精度等。以下是串级PID控制器的调参步骤：

	    首先，调节主控制器的比例系数Kp，以使系统的响应速度达到预期要求。通常情况下，Kp的值越大，系统的响应速度越快，但也会导致系	    统的稳定性下降。

	    接下来，调节主控制器的积分时间Ti，以使系统的稳定性得到保证。一般来说，Ti的值越大，系统的稳定性越好，但也会导致系统的响应	    速度变慢。

	    然后，调节从控制器的比例系数Kp2和积分时间Ti2，以使从控制器对主控制器的输出进行补偿，从而提高系统的控制精度。

	    最后，对主控制器和从控制器的微分时间Td和Td2进行调节，以提高系统的抗干扰能力和控制精度。

	    需要注意的是，串级PID控制器的调参需要根据具体的控制对象和控制要求进行调整，因此需要根据实际情况进行细致的分析和实验。  
【chatgpt】旋转倒立摆是一种经典的控制系统，其控制器通常采用PID控制器。下面是旋转倒立摆PID控制器的编写步骤：

	  1. 确定控制对象：旋转倒立摆通常由两个自由度组成，因此需要设计两个PID控制器，分别控制旋转角度和倒立角度。

	  2. 设计PID控制器：对于旋转角度控制器，可以使用标准的PID控制器，即将控制误差e(t)、积分误差I(t)和微分误差d(t)分别乘以比例系数               	  Kp、积分时间Ti和微分时间Td，然后将它们加权求和得到控制输出u(t)，即：

	   u(t) = Kp * e(t) + Ki * I(t) + Kd * d(t)

	  对于倒立角度控制器，可以采用PD控制器，即只使用比例系数Kp和微分时间Td，不使用积分时间Ti，因为倒立角度的积分误差通常难以		  消除。因此，倒立角度控制器的输出可以表示为：

	   u(t) = Kp * e(t) + Kd * d(t)

	  3. 调整PID参数：PID控制器的参数调整是一个重要的过程，需要根据实际情况进行调整。通常情况下，可以采用试错法或者自适应控制	方法进	  行调整，以使控制系统的响应速度、稳定性和精度达到预期要求。

	  4. 实现控制器：将PID控制器的算法实现到控制器硬件或软件中，实现对旋转倒立摆的控制。

	   需要注意的是，旋转倒立摆的控制器设计和调整需要考虑多个因素，如控制对象的动态特性、控制器的响应速度、稳定性和精度等，因此	   需要进行系统化的分析和实验。 
【chatgpt】旋转倒立摆的控制器通常采用级联控制结构，即将旋转角控制器和倒立角控制器串联起来，形成一个控制系统。具体来说，控制系统的输入是期	   望旋转角度θd，输出是电机的电压控制信号，通过控制电机的转速和方向，实现旋转倒立摆的控制。

	   控制系统的具体实现如下：

	1. 首先，将期望旋转角度θd输入到旋转角控制器中，计算出旋转角度控制器的输出u1(t)，即电机的转速和方向控制信号。

	2. 然后，将旋转角度控制器的输出u1(t)作为倒立角度控制器的输入，计算出倒立角度控制器的输出u2(t)，即电机的电压控制信号。

	3. 最后，将倒立角度控制器的输出u2(t)送入电机控制器中，控制电机的转速和方向，实现旋转倒立摆的控制。

	需要注意的是，控制系统的参数调整需要根据实际情况进行，以达到旋转倒立摆控制的目标。同时，还需要考虑控制系统的稳定性和抗干扰能力，   	以保证控制系统的可靠性和精度。

2023/6/2 【问题】角度环串位置环较难控制，容易出现虽然直立但还是会向某一方向旋转的情况。
	  分析：当摆杆直立时角度环控制输出为零，输入给位置环当目标，在位置环的控制下，如果现在摆臂不是处于零点位置，在位置环控制下就会使	  摆臂旋转，但此时摆杆已经直立，位置环反而会破坏系统的稳定性，而且我们最终的控制目标是让摆杆在某处保持直立状态，所以我们有两个期	  望，1.摆杆的位置；2.摆杆直立；所以我们不因该将位置环的输入（也就是位置的目标值）交给角度环的输出来控制，我们应该将位置环的输出	  当作角度环的输入。
	 
【考虑】位置环串角度环控制
	  分析：假设摆杆已经处于目标位置和保持直立状态，此时位置输出为零，如果摆杆平衡时的实际角度不为零度的情况下，在角度环的控制下，也	  会破坏系统的稳定。所以我们还要将摆杆的平衡位置的角度设置为零度.继续假设摆杆已经处于目标位置和保持直立状态，如果用手使摆杆向右	  转，摆臂会相对摆臂向左转，系统位置偏离目标，直立角度也偏离目标（也就是偏离直立），在位置环的控制下--->摆臂要向目标角度方向旋转	 （向左旋转，也就是摆杆倾倒方向），角度环也是要控制摆臂向倾倒方向旋转。所以位置环串角度环应该可以使系统稳定。
	 
【尝试】使用位置环串角度环
	    tips1：将摆杆平衡位置设置为零度
	    tips2：在pid参数整定之前要先确定pid参数的极性
	 
【问题·已解决】通过ADC采样，采样0~4096范围的值（实际情况却很难看到4096这个值，看见的最大值为4016），再通过（ADC采样值/4096）*360转换为角度的变化范围，ADC采样值数据类型为uint32_t，角度采样数据类型为int，通过上述公式转换会发生隐式类型转换，造成角度反馈精度下降。
	
【问题】在零点向顺时针偏转时（也就是采样值0->4096或者0->360角度跳变时，会出现一小段死区，在这一小段变化范围内，采样值和角度值都为零，沿顺时针方向偏转一段距离后，采样值才从0跳变到4000多，但最大值却是4016。可能也是这小段死区，使0跳变到最大值时不是4096而是4016（也就是说4096~4016之间采样区段处于死区内）
	 分析可能原因：
	1.电位器损坏
	2.采样频率不合适（现在为2ms进行一次采样）
【考虑】将180当0度计算
2023/6/7 【解决】180当0度计算，可以采用，摆角范围变为-180~+180
	 【问题】位置串角度，pid调的不是很好
	 【其他】添加串口，用VOFA+查看波形
	  【现象】摆杆由直立状态倒下时，摆臂不一定会往倒下的反方向运动
	  分行：假设摆杆已经处于目标位置和保持直立状态，如果摆杆往左运动，摆臂未发生偏移，但此时位置环的error为0 整个串级pid控制器输出为	  零，控制器在系统未起作用（控制器未及时响应）。【好像分析有误 】
	 
【问题】位置环串角度环不合理？？？？？？？？？（好像又可以行）
2023/6/10 【问题·已解决】PID积分项有误，错误逻辑：float I_path=(error+last_error)*ki问题出在积分i是对过去所有error的累积，而这里只对上次误差和这次误差进行积分运算。
	   【问题·已解决】pid函数参数列表变量的数据类型有误，用int类型的变量接收float 类型变量的值，隐式类型转换造成精度损失。
	   【问题·已解决】pid error 和last_error 类型有误，用int类型的变量接收float 类型变量的值，隐式类型转换造成精度损失。
2023/6/11 【考虑】添加保护程序，如果倒立摆摆杆偏到多少角度时，禁止控制器对系统进行控制，有利于pid调试，以及机械结构和调试人员的保护
2023/6/21 【问题·已解决】在摆杆已经静止不动时，ADC采样值存在波动情况，角度在1°左右波动，这可能是导致摆杆只能往一边旋转可以平衡，而另一边会加速旋转。所以要考虑对ADC采样值进行滤波处理。
2023/6/21 【问题】在2ms定时器中捕获编码器值时会捕获错误的值（捕获值要么是0要么是1或者是2），改为40ms捕获周期后，可获得正常值。
分析：之前在debug中看pid error和last_error 值时会出现两值一直相等的情况，猜测是由于debug刷新频率的问题，用2ms周期捕获值输出到串口中查看数据。（现象：还是与debug值一样）
【其他】	 位置串角度改为角度并速度，但速度环的目标为角度环的输出，最后将角度环和速度环并行输出。能在一定程度上保持直立，在一段时间内不会向一个方向加速旋转，有一定的鲁棒性（但不多）。
	
